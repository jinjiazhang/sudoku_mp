<!--pages/xiangqi/xiangqi.wxml-->
<view class="page-container">
  <!-- Status Header -->
  <view class="status-header">
    <view class="player-pill {{turn === 'b' ? 'active black' : ''}}">
      <view class="stone-icon black"></view>
      <text class="player-name">黑方 ({{gameMode === 'pve' ? 'AI' : '玩家2'}})</text>
    </view>

    <view class="game-info">
      <view class="status-text">
         <text>{{winner ? '游戏结束' : (turn === 'r' ? '红方思考' : '黑方思考')}}</text>
      </view>
    </view>

    <view class="player-pill {{turn === 'r' ? 'active red' : ''}}">
      <text class="player-name">红方 ({{gameMode === 'pve' ? '玩家' : '玩家1'}})</text>
      <view class="stone-icon red"></view>
    </view>
  </view>

  <view class="board-area">
    <view class="board-wrapper">
        <!-- Static Grid Lines -->
        <view class="grid-lines">
            <!-- 10 Horizontal Lines -->
            <view class="h-line" style="top: calc(100% / 10 * 0.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 1.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 2.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 3.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 4.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 5.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 6.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 7.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 8.5)"></view>
            <view class="h-line" style="top: calc(100% / 10 * 9.5)"></view>

            <!-- Vertical Lines -->
            <!-- Edges (Full height 5% to 95%) -->
            <view class="v-line full" style="left: calc(100% / 9 * 0.5); height: 90%"></view>
            <view class="v-line full" style="left: calc(100% / 9 * 8.5); height: 90%"></view>
            
            <!-- Inner Col 1-7 -->
            <block wx:for="{{[1, 2, 3, 4, 5, 6, 7]}}" wx:key="*this">
               <view class="v-line" style="left: calc(100% / 9 * ({{item}} + 0.5))"></view>
               <view class="v-line bottom" style="left: calc(100% / 9 * ({{item}} + 0.5))"></view>
            </block>

            <!-- Palace lines -->
            <!-- Top Palace Center (Row 1.5 -> 15%) -->
            <view class="palace-line" style="top: 15%; transform: translate(-50%, -50%) rotate(45deg);"></view>
            <view class="palace-line" style="top: 15%; transform: translate(-50%, -50%) rotate(-45deg);"></view>
            
            <!-- Bottom Palace Center (Row 8.5 -> 85%) -->
             <view class="palace-line" style="top: 85%; transform: translate(-50%, -50%) rotate(45deg);"></view>
             <view class="palace-line" style="top: 85%; transform: translate(-50%, -50%) rotate(-45deg);"></view>
        </view>
        
        <view class="river">
            <view class="river-half"><text>楚</text><text>河</text></view>
            <view class="river-half"><text>汉</text><text>界</text></view>
        </view>
    
        <view class="board">
        <block wx:for="{{boardData}}" wx:key="row" wx:for-item="row" wx:for-index="rIdx">
            <view class="board-row">
                <block wx:for="{{row}}" wx:key="col" wx:for-item="cell" wx:for-index="cIdx">
                <view class="cell {{selectedPos.row === rIdx && selectedPos.col === cIdx ? 'selected' : ''}} {{lastMove.from.row === rIdx && lastMove.from.col === cIdx ? 'last-move-from' : ''}}" 
                        bindtap="onCellTap" 
                        data-row="{{rIdx}}" 
                        data-col="{{cIdx}}">
                        
                        <block wx:for="{{validMoves}}" wx:for-item="move" wx:key="index">
                            <view wx:if="{{move.row === rIdx && move.col === cIdx}}" class="valid-move-marker"></view>
                        </block>

                        <view wx:if="{{cell.piece}}" 
                            class="piece {{cell.piece.color === 'r' ? 'red' : 'black'}} {{lastMove.to.row === rIdx && lastMove.to.col === cIdx ? 'last-move' : ''}}">
                            {{cell.piece.text}}
                        </view>
                </view>
                </block>
            </view>
        </block>
        </view>
    </view>
  </view>

  <view class="controls-area">
    <view class="tool-btn" bindtap="undoMove">
      <view class="icon-circle">↶</view>
      <text>悔棋</text>
    </view>
    <view class="tool-btn" bindtap="restartGame">
      <view class="icon-circle">↺</view>
      <text>重玩</text>
    </view>
  </view>
</view>
