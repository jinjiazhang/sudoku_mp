<!--pages/xiangqi/xiangqi.wxml-->
<view class="page-container">
  <!-- Status Header -->
  <view class="status-header">
    <view class="player-pill {{turn === 'b' ? 'active black' : ''}}">
      <view class="stone-icon black"></view>
      <text class="player-name">ÈªëÊñπ ({{gameMode === 'pve' ? 'AI' : 'Áé©ÂÆ∂2'}})</text>
    </view>

    <view class="game-info">
      <view class="status-text">
         <text>{{winner ? 'Ê∏∏ÊàèÁªìÊùü' : (turn === 'r' ? 'Á∫¢ÊñπÊÄùËÄÉ' : 'ÈªëÊñπÊÄùËÄÉ')}}</text>
      </view>
    </view>

    <view class="player-pill {{turn === 'r' ? 'active red' : ''}}">
      <text class="player-name">Á∫¢Êñπ ({{gameMode === 'pve' ? 'Áé©ÂÆ∂' : 'Áé©ÂÆ∂1'}})</text>
      <view class="stone-icon red"></view>
    </view>
  </view>

  <view class="board-area">
    <view class="board-wrapper">
        <!-- Static Grid Lines -->
        <view class="grid-lines">
            <!-- 10 Horizontal Lines -->
            <view class="h-line" style="top: 5%"></view>
            <view class="h-line" style="top: 15%"></view>
            <view class="h-line" style="top: 25%"></view>
            <view class="h-line" style="top: 35%"></view>
            <view class="h-line" style="top: 45%"></view>
            <view class="h-line" style="top: 55%"></view>
            <view class="h-line" style="top: 65%"></view>
            <view class="h-line" style="top: 75%"></view>
            <view class="h-line" style="top: 85%"></view>
            <view class="h-line" style="top: 95%"></view>

            <!-- Vertical Lines -->
            <!-- Edges (Full height 5% to 95%) -->
            <view class="v-line full" style="left: 5.55%; height: 90%"></view>
            <view class="v-line full" style="left: 94.44%; height: 90%"></view>
            
            <!-- Inner Col 1-7 -->
            <block wx:for="{{[16.66, 27.77, 38.88, 50, 61.11, 72.22, 83.33]}}" wx:key="*this">
               <view class="v-line" style="left: {{item}}%"></view>
               <view class="v-line bottom" style="left: {{item}}%"></view>
            </block>

            <!-- Palace lines -->
            <!-- Top Palace (col 38.88 to 61.11, row 5 to 25 -->
            <!-- Center is 50, 15 -->
            <!-- Width 22.22%, Height 20% -->
            <!-- Rotate ~42deg -->
            <!-- Use polygon or simply lines connecting corners -->
            <view class="palace-line" style="left: 50%; top: 5%; height: 26%; width: 2rpx; transform: rotate(48deg); transform-origin: top center;"></view>
            <view class="palace-line" style="left: 50%; top: 5%; height: 26%; width: 2rpx; transform: rotate(-48deg); transform-origin: top center;"></view>
            
            <!-- Bottom Palace: Top is 75%. Same but rotate from bottom? Or just position top -->
            <!-- Center is 50, 85 -->
             <view class="palace-line" style="left: 50%; top: 75%; height: 26%; width: 2rpx; transform: rotate(48deg); transform-origin: top center;"></view>
             <view class="palace-line" style="left: 50%; top: 75%; height: 26%; width: 2rpx; transform: rotate(-48deg); transform-origin: top center;"></view>
        </view>
        
        <view class="river"><text>Ê•öÊ≤≥ Ê±âÁïå</text></view>
    
        <view class="board">
        <block wx:for="{{boardData}}" wx:key="row" wx:for-item="row" wx:for-index="rIdx">
            <view class="board-row">
                <block wx:for="{{row}}" wx:key="col" wx:for-item="cell" wx:for-index="cIdx">
                <view class="cell {{selectedPos.row === rIdx && selectedPos.col === cIdx ? 'selected' : ''}} {{lastMove.from.row === rIdx && lastMove.from.col === cIdx ? 'last-move-from' : ''}}" 
                        bindtap="onCellTap" 
                        data-row="{{rIdx}}" 
                        data-col="{{cIdx}}">
                        
                        <block wx:for="{{validMoves}}" wx:for-item="move" wx:key="index">
                            <view wx:if="{{move.row === rIdx && move.col === cIdx}}" class="valid-move-marker"></view>
                        </block>

                        <view wx:if="{{cell.piece}}" 
                            class="piece {{cell.piece.color === 'r' ? 'red' : 'black'}} {{lastMove.to.row === rIdx && lastMove.to.col === cIdx ? 'last-move' : ''}}">
                            {{cell.piece.text}}
                        </view>
                </view>
                </block>
            </view>
        </block>
        </view>
    </view>
  </view>

  <view class="controls-area">
    <view class="tool-btn" bindtap="restartGame">
      <view class="icon-circle">üîÑ</view>
      <text>ÈáçÊñ∞ÂºÄÂßã</text>
    </view>
    <view class="tool-btn" bindtap="goBack">
      <view class="icon-circle">üö™</view>
      <text>ÈÄÄÂá∫</text>
    </view>
  </view>
</view>
